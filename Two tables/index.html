<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" name=viewport content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <script>
        var arrProducts = [];

        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }
        function setProduct (name, shelfLife, count) {
            try {
              if (arguments.length < 2) {
                throw new Error("Объект продукта не заполнен полностью");
              }
              var object = new Object();
              object.name = name;
              object.shelfLife = shelfLife;
              if (count) {
                object.count = count;
              } else {
                object.count = 1;
              }
              object.datePurchase = new Date();
              object.index = arrProducts.length;
              arrProducts.push(object);
            } catch (e) {
              alert("Извините, в данных ошибка. Таблица будет не полной.");
            }
        }
        function deleteProduct(index){
          arrProducts.splice(index, 1);
        }
        function createDivContainer() {
          let div = document.createElement("div");
          div.className = "container";
          document.body.appendChild(div);
        }
        function writeProducts() {
          let div = document.querySelector('.container'); 
          div.appendChild(createTableProducts(arrProducts)); 
          div.appendChild(document.createElement('br'));
        }
        function updateShelfLifes() {
          nowDay = new Date();
          for(var i = 0; i < arrProducts.length; i++) {
            var difference = nowDay - arrProducts[i].datePurchase;
            difference = new Date(difference);
            difference = difference.getDate();
            arrProducts[i].shelfLife = arrProducts[i].shelfLife - difference;
          }
        }
        function createTableProducts(arr) {
          let table = document.createElement("table");
          let thead = document.createElement("thead");
          let th1 = document.createElement("th");
          th1.innerHTML = "<h2>Род и вид</h2>";
          thead.appendChild(th1);
          let th2 = document.createElement("th");
          th2.innerHTML = "<h2>Срок годности</h2>"
          thead.appendChild(th2)
          let th3 = document.createElement("th");
          th3.innerHTML = "<h2>Количество</h2>";
          thead.appendChild(th3);
          let th4 = document.createElement("th");
          thead.appendChild(th4);
          table.appendChild(thead);
          let tbody = document.createElement("tbody");
          for (let i = 0; i < arr.length; i++) {
            let tr = document.createElement("tr");
            let td1 = document.createElement("td");
            td1.innerHTML = "<p>" + arr[i].name + "</p>";
            let td2 = document.createElement("td");
            td2.innerHTML = "<p>" + arr[i].shelfLife + " дн.</p>";
            let td3 = document.createElement("td");
            td3.innerHTML = "<p>" + arr[i].count + "шт. </p>";
            let td4 = document.createElement("td");
            td4.innerHTML = "<div class='switch' select='off' index='" + arr[i].index + "'></div>";
            td4.style.padding = "0.5em";
            tr.appendChild(td1);
            tr.appendChild(td2);
            tr.appendChild(td3);
            tr.appendChild(td4);
            tbody.appendChild(tr);
          }
          table.appendChild(tbody);
          table.className = "arr-products";
          table.addEventListener("click", toggleChoiceButton);
          return table;
        }
        function rationalChoice() {
          var arrMinShelfLife = [];
          var minShelfLife = arrProducts[0].shelfLife;
          var alertString = "";
          for(var i = 0; i < arrProducts.length; i++) {
              if (arrProducts[i].shelfLife < minShelfLife) {
                  minShelfLife = arrProducts[i].shelfLife;
              }
          }
          for(i = 0; i < arrProducts.length; i++) {
              if(minShelfLife == arrProducts[i].shelfLife) {
                  arrMinShelfLife.push(arrProducts[i]);
              }
          }
          let table = createTableProducts(arrMinShelfLife);
          let div = document.createElement("div");
          div.className = "rational-choice";
          div.appendChild(table);
          let button = document.createElement("div");
          button.innerHTML = "<p>Случайный выбор</p>";
          button.className = "button";
          button.addEventListener("click", function(){
            i = getRandomInt(0, (arrMinShelfLife.length - 1));
            alert(arrMinShelfLife[i].name + " - " + arrMinShelfLife[i].shelfLife + " дн. ");
          });
          div.appendChild(document.createElement('br'));
          div.appendChild(button);
          div.setAttribute("id", "min-shelfLife");
          div.hidden = true;
          return div;
        }
        function createButtonRationalChoice() {
          let buttonRationalChoice = document.createElement("div");
          buttonRationalChoice.className = "button";
          buttonRationalChoice.innerHTML = "<p>Рациональный выбор</p>";
          buttonRationalChoice.addEventListener("click", function(){
            div = document.getElementById("min-shelfLife");
            div.hidden = !div.hidden;
          });
          let div = document.querySelector('.container');
          div.appendChild(buttonRationalChoice);
          div.appendChild(document.createElement('br'));
          div.appendChild(rationalChoice());
          div.appendChild(document.createElement('br'));
        }
        function toggleChoiceButton(event) {
          if (event.target.className == "switch") {
            if (event.target.getAttribute("select") == "off") {
              event.target.style.backgroundColor = "#f40";
              event.target.setAttribute("select", "on");
              let index = event.target.getAttribute("index");
              let switches = document.querySelectorAll(".switch");
              for (let i = 0; i < switches.length; i++) {
                if (switches[i].getAttribute("index") == index) {
                  switches[i].style.backgroundColor = "#f40";
                  switches[i].setAttribute("select", "on");
                }
              }
              return;
            } else if (event.target.getAttribute("select") == "on") {
              event.target.style.backgroundColor = "#0f9";
              event.target.setAttribute("select", "off");
              let index = event.target.getAttribute("index");
              let switches = document.querySelectorAll(".switch");
              for (let i = 0; i < switches.length; i++) {
                if (switches[i].getAttribute("index") == index) {
                  switches[i].style.backgroundColor = "#0f9";
                  switches[i].setAttribute("select", "off");
                }
              }
              return;
            } else {
              alert("Button Error");
            }
          } else {
            return;
          }
        }
        function saveChanges() {
          let confidence = confirm("Вы уверены, что хотите сохранить результат?");
          if (confidence) {
            let switches = document.body.querySelectorAll(".switch");
            for (let i = 0; i < switches.length; i++) {
              if (switches[i].getAttribute("select") == "on") {
                let index = switches[i].getAttribute("index");
                deleteProduct(index);
              } else {
                continue;
              }
            }
          } else {
            return;
          }
        }
        function createButtonSaveChanges() {
          let div = document.createElement("div");
          div.className = "button";
          div.innerHTML = "<p>Сохранить изменения</p>";
          div.addEventListener("click", saveChanges);
          let container = document.body.querySelector(".container");
          container.appendChild(div);
        }
        createDivContainer();
        setProduct("Яблоко", 2, 4);
        setProduct("Куриные котлеты", 4, 6);
        setProduct("Сыр", 6);
        setProduct("Колбаса", 3);
        setProduct("Бананы", 2, 6);
        writeProducts();
        createButtonRationalChoice();
        createButtonSaveChanges();
    </script>
  </body>
</html>