<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" name=viewport content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="style.css">
    <link href="fonts/Roboto_Condensed/font.css" rel="stylesheet">
    <script src="form.js"></script>
    <!--<script src="C:\Users\Николай Луценко\Documents\GitHub\form.js"></script>-->
    <script src="note.js"></script>
    <script src="switch.js"></script>
    <script src="table.js"></script>
  </head>
  <body>
    <script>
        var arrProducts = localStorage.arrProducts ? JSON.parse(localStorage.arrProducts) : [];
        var productsCollection = localStorage.productsCollection ? JSON.parse(localStorage.productsCollection) : {};
        var shoppingLists = localStorage.shoppingLists ? JSON.parse(localStorage.shoppingLists) : {};
        class Product {
          constructor(name, shelfLife, count) {
            this.name = name;
            this.shelfLife = shelfLife;
            this.count = count;
            this.datePurchase = new Date();
            this.datePurchase.setHours(0, 0, 0, 0);
            this.countType = document.forms.addProduct.elements.countType.value;
            this.frozen = document.forms.addProduct.elements.checkFrozen.checked;
            this.index = arrProducts.length;
          }
          createProduct(event) {
            event.preventDefault();
            let name = document.forms.createProduct.elements.name1.value;
            let shelfLifeFrozen = parseInt(document.forms.createProduct.elements.defaultShelfLifeFrozen.value);
            let shelfLifeNotFrozen = parseInt(document.forms.createProduct.elements.defaultShelfLifeNotFrozen.value);
            if (!name || !isNumeric(shelfLifeFrozen) || !isNumeric(shelfLifeNotFrozen)) {
              alert("Форма заполнена неправильно");
              return;
            }
            name = name.toUpperCase();
            let a = true;
            for (let i in productsCollection) {
              if (i == name) {
                a = false;
              }
            }
            if (a) {
              productsCollection[name] =  {shelfLifeFrozen: shelfLifeFrozen, shelfLifeNotFrozen: shelfLifeNotFrozen, numberAdditions: 0};
              let arr = [];
              let obj = productsCollection;
              for (let i in obj) {
                obj[i].name = i;
                arr.push(obj[i]);
              }
              arr = sortProducts(arr, "name");
              productsCollection = {};
              for (let i in arr) {
                productsCollection[arr[i].name] = arr[i];
                delete productsCollection[arr[i].name].name;
              }
              localStorage.productsCollection = JSON.stringify(productsCollection);
              let select = document.querySelector("#form select");
              select.innerHTML = "";
              for (let i in productsCollection) {
                let option = new Option(i, i);
                select.appendChild(option);
              }
              alert("Продукт успешно добавлен в коллекцию");
            } else {
            alert("В коллекции уже есть продукт с таким именем");
            }
          }
          addProduct(event) {
            if (!document.forms.addProduct.elements.countType.value) {
              alert("Не указана единица измерения. Исправьте, и повторите попытку.");
              return;
            }
            event.preventDefault();
            let name = document.forms.addProduct.elements.name2.value;
            let count = parseFloat(document.forms.addProduct.elements.count.value);
            if (count <= 0 || !isNumeric(count)) {
              alert("Количество не может быть меньше или равно 0");
              return;
            }
            let shelfLife = parseInt(document.forms.addProduct.elements.shelfLife.value);
            let i = 0;
            let product = arrProducts[i];
            while (i < arrProducts.length) {
              if (product.name !== name) {
                i++;
                product = arrProducts[i];
              } else {
                if (product.shelfLife == shelfLife) {
                  product.count += count;
                  localStorage.arrProducts = JSON.stringify(arrProducts);
                  let tr = document.querySelectorAll(".arr-products tr");
                  tr[i].children[2].innerHTML = product.count + " " + product.countType;
                  alert("Продукт успешно добавлен");
                  productsCollection[product.name].numberAdditions++;
                  localStorage.productsCollection = JSON.stringify(productsCollection);
                  return;
                }
                i++;
              }
            }
            let obj = new Product(name, shelfLife, count);
            arrProducts.push(obj);
            localStorage.arrProducts = JSON.stringify(arrProducts);
            let tr = createTrProduct(arrProducts, obj.index);
            document.querySelector(".arr-products tbody").appendChild(tr);
            productsCollection[name].numberAdditions++;
            localStorage.productsCollection = JSON.stringify(productsCollection);
            alert("Продукт успешно добавлен");
            if (!localStorage._checker) {
              let time = new Date();
              time.setHours(0, 0, 0, 0);
              localStorage._checker = time;
            }
          }
          deleteProduct(index){
            arrProducts.splice(index, 1);
            for (let i = index; i < arrProducts.length; i++) {
              arrProducts[i].index -= 1;
            }
          }
        }
        class ShoppingListItem extends Tr {
          constructor(name, count, options) {
            super("tr", [{innerHTML: new Switch({select: "off"}).elem.outerHTML}, {innerHTML: name}, {innerHTML: count}], options)
          }
          render() {
            super.render();
          }
        }
        class ShoppingList extends Table {
          constructor(header, elements, options) {
            this.header = header;
            super();
          }
          render() {
            super.render();
          }
          addItem(name, count) {
            let item = new ShoppingListItem(name, count);
            this.elements.push(item);
            this.render();
          }
        }
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }
        function fadeOut(time){ 
        let EndTime = Date.now() + time;
        let _this = this;
        handler();
        function handler(){
            let now = Date.now();
            let step = EndTime - now;
            if(step/time < 0 ){
                _this.style.opacity = 0;
                return;            
            }
              else
          _this.style.opacity = (step/time);
            setTimeout(handler,0);
          }
        }
        Element.prototype.fadeOut = fadeOut;
        function isNumeric(n) {
          return !isNaN(parseFloat(n)) && isFinite(n);
        }
        function sortProducts(arr, method) {
          if (method == "name") {
            [].sort.call(arr, function (a, b) {
              if (a.name < b.name) {
                return -1;
              }
              if (a.name > b.name) {
                return 1;
              }
              // names must be equal
              return 0;
            });
          } else if (method == "shelfLife") {
            arr.sort(function(a, b) {
              if (a.shelfLife < b.shelfLife) {
                return -1;
              }
              if (a.shelfLife > b.shelfLife) {
                return 1;
              }
              return 0;
            });
          } else if (method == "count") {
            let pieces = [];
            let kg = [];
            let g = [];
            for (let i = 0; i < arr.length; i++) {
              switch(arr[i].countType) {
                case "ШТ":
                  pieces.push(arr[i]);
                  break;
                case "КГ":
                  kg.push(arr[i]);
                  break;
                case "Г":
                  g.push(arr[i]);
                  break;
              }
            }
            function sortCount(a, b) {
              if (a.count < b.count) {
                return -1;
              }
              if (a.count > b.count) {
                return 1;
              }
              return 0;
            }
            pieces.sort(sortCount);
            kg.sort(sortCount);
            g.sort(sortCount);
            arr = [];
            function add(a) {
              for (let i = 0; i < a.length; i++) {
                arr.push(a[i]);
              }
            }
            add(pieces);
            add(kg);
            add(g);
          }
          return arr;
        }
        function createDivContainer() {
          let div = document.createElement("div");
          div.className = "container";
          document.body.appendChild(div);
        }
        function selectSection(event) {
          if (document.body.querySelector(".visible")) {
            document.body.querySelector(".visible").className = "invisible";
            document.body.querySelector("#" + event.target.getAttribute("key")).className = "visible";
            if (document.body.clientWidth < 768) {
              document.querySelector("body").classList.toggle("navOpen");
              document.querySelector("nav").classList.toggle("open");
              document.querySelector(".container").classList.toggle("open");
              document.querySelector(".openNav").classList.toggle("open");
            }
          }
        }
        function createMenu() {
          let section = document.createElement("section");
          section.className = "menu";
          let nav = document.createElement("nav");
          let ul = document.createElement("ul");
          let main = document.createElement("li");
          main.innerHTML = "Главная";
          main.setAttribute("key", "main");
          main.addEventListener("click", selectSection);
          ul.appendChild(main);
          let form = document.createElement("li");
          form.innerHTML = "Добавить продукт";
          form.setAttribute("key", "form");
          form.addEventListener("click", selectSection);
          ul.appendChild(form);
          let about = document.createElement("li");
          about.innerHTML = "О сервисе";
          about.setAttribute("key", "about");
          about.addEventListener("click", selectSection);
          ul.appendChild(about);
          nav.appendChild(ul);
          section.appendChild(nav);
          let openNav = document.createElement("div");
          openNav.className = "openNav";
          openNav.addEventListener("click", function(){
            document.querySelector("body").classList.toggle("navOpen");
            document.querySelector("nav").classList.toggle("open");
            document.querySelector(".container").classList.toggle("open");
            openNav.classList.toggle("open");
          });
          let icon = document.createElement("div");
          icon.className = "icon";
          openNav.appendChild(icon);
          section.appendChild(openNav);
          document.body.appendChild(section);
        }
        function showComment(event) {
          let target = event.target;
          while (target.className !== "note") {
            target = target.parentNode;
          }
          target.children[0].hidden = !target.children[0].hidden;
        }
        function focusRadioParagraph(event) {
          if (event.target.tagName == "P") {
            event.target.children[0].checked = true;
          }
        }
        function changeShelfLifeValue(event) {
          if (productsCollection) {
            if (event.target.tagName = "select") {
              for (let i in productsCollection) {
                if (i == document.forms.addProduct.elements.name2.value) {
                  if (document.forms.addProduct.elements.checkFrozen.checked) {
                    document.forms.addProduct.elements.shelfLife.value = productsCollection[i].shelfLifeFrozen;
                  } else {
                    document.forms.addProduct.elements.shelfLife.value = productsCollection[i].shelfLifeNotFrozen;
                  }
                  break;
                }
              }
            } else {
              if (document.forms.addProduct.elements.checkFrozen.checked) {
                document.forms.addProduct.elements.shelfLife.value = productsCollection[i].shelfLifeFrozen;
              } else {
                document.forms.addProduct.elements.shelfLife.value = productsCollection[i].shelfLifeNotFrozen;
              }
            }
          }
        }
        function createProductForm() {
          let elements = [new Input("name1", "Название продукта"), new Note("Примечание", "Лучше указать запись вида: род + вид. Желательно использовать множественное число."), new Num("defaultShelfLifeFrozen", "Срок годности в холодильнике", {min: 0}), new Num("defaultShelfLifeNotFrozen", "Срок годности при комнатной температуре", {min: 0})];
          return new Form("createProduct", elements, "Добавить новый продукт в коллекцию", Product.prototype.createProduct, new Submit("submit", "Отправить"));
        }
        function addProductForm() {
          let options = [];
          for (let i in productsCollection) {
            let option = {text: i, value: i};
            options.push(option);
          }
          let select = new Select("name2", options, "Название продукта");
          select.elem.addEventListener("blur", changeShelfLifeValue);
          let shelfLife = new Num("shelfLife", "Текущий срок годности");
          if (productsCollection) {
            for (let i in productsCollection) {
              if (i == select.elem.value) {
                shelfLife.elem.value = productsCollection[i].shelfLifeFrozen;
                break;
              }
            }
          }
          let checkbox = new Checkbox("checkFrozen", "Продукт в холодильнике?");
          checkbox.elem.addEventListener("blur", changeShelfLifeValue);
          let radio = [{name: "countType", header: "ШТ", value: "ШТ"}, {name: "countType", header: "КГ", value: "КГ"}, {name: "countType", header: "Г", value: "Г"}];
          let elements = [select, checkbox, shelfLife, new Num("count", "Количество"), new RadioList("Единица измерения", radio)]
          return new Form("addProduct", elements, "Добавить продукт", Product.prototype.addProduct, new Submit("submit", "Отправить"));
        }
        function createSectionFormProduct() {
          let section = document.createElement("section");
          section.setAttribute("id", "form");
          section.appendChild(createProductForm().elem);
          section.appendChild(addProductForm().elem);
          section.className = "invisible";
          document.body.querySelector(".container").appendChild(section);
        }
        function updateShelfLifes() {
          if (!localStorage._checker) {
            return;
          }
          let nowDay = new Date();
          nowDay.setHours(0, 0, 0, 0);
          let checker = new Date(localStorage._checker);
          console.log(checker + " " + nowDay);
          if (parseInt(checker.getTime()) !== nowDay.getTime()) {
            for(let i = 0; i < arrProducts.length; i++) {
              let difference = nowDay.getTime() - checker.getTime();
              difference = difference/86400000;
              console.log("Difference - " + difference); 
              console.log("Current shelf life - " + arrProducts[i].shelfLife);
              arrProducts[i].shelfLife = arrProducts[i].shelfLife - difference;
            }
            localStorage.arrProducts = JSON.stringify(arrProducts);
            localStorage._checker = nowDay;
          }
        }
        function createTbodyProducts(arr) {
          let tbody = document.createElement("tbody");
          for (let i = 0; i < arr.length; i++) {
            tbody.appendChild(createTrProduct(arr, i));
          }
          return tbody;
        }
        function createTrProduct(arr, i) {
          let tr = document.createElement("tr");
          tr.setAttribute("index", arr[i].index);
          function createTd(content) {
            let td = document.createElement("td");
            td.innerHTML = content;
            tr.appendChild(td);
          }
          createTd("<p>" + arr[i].name + "</p>");
          createTd("<p>" + arr[i].shelfLife + " дн</p>");
          createTd("<p>" + arr[i].count + " " + arr[i].countType + "</p>");
          createTd(new Switch({select: "off", index: arr[i].index, count: 0}).elem.outerHTML);
          if (arr[i].frozen) {
            tr.className = "frozen";
          }
          return tr;
        }
        function sortTableProducts(event) {
          if (document.querySelector(".arr-products tbody")) {

            switch (event.target.innerHTML[0]) {
              case "Р":
                var arr = sortProducts(arrProducts, "name");
                break;
              case "С":
                var arr = sortProducts(arrProducts, "shelfLife");
                break;
              case "К":
                var arr = sortProducts(arrProducts, "count");
                break;
            }
            let tbody = createTbodyProducts(arr);
            let table = document.querySelector(".arr-products");
            table.removeChild(table.querySelector("tbody"));
            table.appendChild(tbody);
          }
        }
        function createTableProducts(arr) {
          let table = document.createElement("table");
          table.setAttribute("cellspacing", "0");
          let thead = document.createElement("thead");
          function createTh(content) {
            let th = document.createElement("th");
            th.innerHTML = content;
            th.firstChild.addEventListener("click", sortTableProducts);
            thead.appendChild(th); 
          }
          createTh("<p>Род и вид</p>");
          createTh("<p>Срок годности</p>");
          createTh("<p>Количество</p>");
          thead.children[2].setAttribute("colspan", 2);
          table.appendChild(thead);
          let tbody = createTbodyProducts(arr);
          table.appendChild(tbody);
          table.className = "arr-products";
          table.addEventListener("click", toggleChoiceButton);
          return table;
        }
        function rationalChoice() {
          let arrMinShelfLife = [];
          let minshelfLife = arrProducts[0].shelfLife;
          let alertString = "";
          for(let i = 0; i < arrProducts.length; i++) {
              if (arrProducts[i].shelfLife < minshelfLife) {
                  minshelfLife = arrProducts[i].shelfLife;
              }
          }
          for(let i = 0; i < arrProducts.length; i++) {
              if(minshelfLife == arrProducts[i].shelfLife) {
                  arrMinShelfLife.push(arrProducts[i]);
              }
          }
          let rows = document.querySelectorAll('.arr-products tr');
          for (let i = 0; i < arrMinShelfLife.length; i++) {
            for (let j = 0; j < rows.length; j++) {
              if (rows[j].getAttribute('index') == arrMinShelfLife[i].index) {
                rows[j].className = 'lighted';
              }
            }
          }
          let button = document.getElementById("random-choice");
          button.hidden = false;
        }
        function createButtonRationalChoice() {
          let button = document.createElement("div");
          button.className = "button";
          button.innerHTML = "<p>Рациональный выбор</p>";
          button.addEventListener("click", rationalChoice);
          return button;
        }
        function randomChoiceOfRationals() {
          let arrMinShelfLife = [];
          let minshelfLife = arrProducts[0].shelfLife;
          let alertString = "";
          for(let i = 0; i < arrProducts.length; i++) {
              if (arrProducts[i].shelfLife < minshelfLife) {
                  minshelfLife = arrProducts[i].shelfLife;
              }
          }
          for(let i = 0; i < arrProducts.length; i++) {
              if(minshelfLife == arrProducts[i].shelfLife) {
                  arrMinShelfLife.push(arrProducts[i]);
              }
          }
           i = getRandomInt(0, (arrMinShelfLife.length - 1));
            alert(arrMinShelfLife[i].name + " - " + arrMinShelfLife[i].shelfLife + " дн " + " - " + arrMinShelfLife[i].count + " " + arrMinShelfLife[i].countType);
        }
        function createButtonRandomChoiceOfRationals() {
          let button = document.createElement('div');
          button.className = "button";
          button.innerHTML = "<p>Случайная подсказка</p>";
          button.setAttribute("id", "random-choice");
          button.addEventListener("click", randomChoiceOfRationals);
          button.hidden = true;
          return button;
        }
        function toggleChoiceButton(event) {
          let target = event.target;
          if (target.className == "switch" || target.parentNode.className == "switch") {
            if (target.getAttribute("select") == "off") {
              target.style.backgroundColor = "#f40";
              target.setAttribute("select", "on");
              let num = document.createElement('p');
              num.innerHTML = '1';
              target.appendChild(num);
              target.setAttribute("count", "1");
            } else {
              if (target.className !== "switch") {
                target = target.parentNode;
              }
              let i = target.parentNode.parentNode.getAttribute("index");
              let maxCount = arrProducts[i].count;
              let absoluteCount = parseInt(prompt("Сколько всего вы хотите выделить?"));
              if (absoluteCount == 0 || false) {
                target.removeChild(target.firstChild);
                target.style.backgroundColor = "#0f9";
                target.setAttribute("select", "off");
                target.setAttribute("count", "0");
              } else if (absoluteCount > 0) {
                if (absoluteCount > maxCount) {
                  absoluteCount = maxCount;
                }
                target.setAttribute("count", absoluteCount);
                target.innerHTML = "<p>" + absoluteCount + "</p>";
              }
            }
          }
        }
        function saveChanges() {
          let confidence = confirm("Вы уверены, что хотите сохранить результат?");
          if (confidence) {
            if (!localStorage._checker) {
            let time = new Date();
            time.setHours(0, 0, 0, 0);
            localStorage._checker = time;
            }
            let switches = document.body.querySelectorAll(".switch");
            let toTrash = [];
            for (let i = 0; i < switches.length; i++) {
              let j = switches[i].getAttribute("index");
              let maxCount = arrProducts[j].count;
              let count = switches[i].getAttribute("count");
              if (count == maxCount) {
                toTrash.push(i)
              } else if (count !== 0) {
                let newCount = maxCount - count;
                arrProducts[j].count = newCount;
                switches[i].setAttribute("count", newCount);
                switches[i].parentNode.parentNode.children[2].innerHTML = newCount + " " + arrProducts[j].countType;
                switches[i].innerHTML = "";
                switches[i].style.backgroundColor = "#0f9";
                switches[i].setAttribute("select", "off");
                switches[i].setAttribute("count", "0");
              }
            }
            if(toTrash.length){
              toTrash.reverse().forEach(i=>{
                Product.prototype.deleteProduct(i);
                switches[i].closest('tr').fadeOut(500); 
                setTimeout(function() {
                  switches[i].closest('tr').remove(); 
                }, 600);
              })
              setTimeout(function(){
                let trs = document.querySelectorAll('.arr-products tbody tr');
                Array.prototype.forEach.call(trs,(e, ind)=>{
                    e.setAttribute('index', ind);
                    e.querySelector('.switch').setAttribute('index', ind);
                })
              },1100)
            }
          localStorage.arrProducts = JSON.stringify(arrProducts);
          localStorage.productsCollection = JSON.stringify(productsCollection);
          }
        }
        function createButtonSaveChanges() {
          let button = document.createElement("div");
          button.className = "button";
          button.innerHTML = "<p>Сохранить изменения</p>";
          button.addEventListener("click", saveChanges);
          return button;
        }
        function createAbout() {
          let section = document.createElement("section");
          section.setAttribute("id", "about");
          section.innerHTML = "<h1>О сервисе</h1><p>Задача программы – автоматическая сортировка продуктов по сроку годности. В будущем будет реализованы рекомендации и список попупок</p><p>Автор – Nick Elixir</p>";
          section.className = "invisible";
          document.body.querySelector(".container").appendChild(section);
        }
        function writeProducts() {
          let div = document.querySelector('.container'); 
          let section = document.createElement("section");
          section.setAttribute("id", "main");
          section.className = "visible";
          section.appendChild(createTableProducts(arrProducts));
          section.appendChild(createButtonRationalChoice());
          section.appendChild(createButtonRandomChoiceOfRationals());
          section.appendChild(createButtonSaveChanges());
          let p = document.createElement("p");
          p.innerHTML = "При нажатии на заголовок колонки можно отсортировать таблицу по соответстующей характеристике.";
          section.appendChild(p);
          div.appendChild(section);
        }
        function createShoppingListSection() {
          let section = document.createElement("section");
          section.setAttribute("id", "create-shopping-list");
          section.className("invisible");
		      let form = new Form("createShoppingList", [new Input("shoppingListName", "Название")], "Создать список продуктов");
          section.appendChild(form.elem);

        }
        updateShelfLifes();
        createMenu();
        createDivContainer();
        writeProducts();
        createSectionFormProduct();
        createAbout();
        console.log(performance.now());
    </script>
  </body>
</html>