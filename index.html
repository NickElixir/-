<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" name=viewport content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="style.css">
    <link href="fonts/Roboto_Condensed/font.css" rel="stylesheet">
  </head>
  <body>
    <script>
        let arrProducts = [];
		    let arrProductsCollection = ["Бананы", "Яблоки", "Апельсины"];
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }
        function fadeOut(time){ 
        let EndTime = Date.now() + time;
        let _this = this;
        handler();
        function handler(){
            let now = Date.now();
            let step = EndTime - now;
            if(step/time < 0 ){
                _this.style.opacity = 0;
                return;            
            }
              else
          _this.style.opacity = (step/time);
            setTimeout(handler,0);
          }
        }
        Element.prototype.fadeOut = fadeOut;        
        function setProduct (name, shelflife, count) {
          try {
            if (arguments.length < 2) {
              throw new Error("Объект продукта не заполнен полностью");
            }
            let object = new Object();
            object.name = name;
            object.shelflife = shelflife;
            if (count) {
              object.count = count;
            } else {
              object.count = 1;
            }
            object.datePurchase = new Date();
            object.index = arrProducts.length;
            arrProducts.push(object);
          } catch (e) {
            alert("Извините, в данных ошибка. Таблица будет не полной.");
          }
        }
        function deleteProduct(index){
          arrProducts.splice(index, 1);
        }
        function createDivContainer() {
          let div = document.createElement("div");
          div.className = "container";
          document.body.appendChild(div);
        }
        function selectSection(event) {
          if (document.body.querySelector(".visible")) {
            document.body.querySelector(".visible").className = "invisible";
            document.body.querySelector("#" + event.target.getAttribute("key")).className = "visible";
          }
        }
        function createMenu() {
          let section = document.createElement("section");
          section.className = "menu";
          let nav = document.createElement("nav");
          let ul = document.createElement("ul");
          let main = document.createElement("li");
          main.innerHTML = "Главная";
          main.setAttribute("key", "main");
          main.addEventListener("click", selectSection);
          ul.appendChild(main);
          let form = document.createElement("li");
          form.innerHTML = "Добавить продукт";
          form.setAttribute("key", "form");
          form.addEventListener("click", selectSection);
          ul.appendChild(form);
          let about = document.createElement("li");
          about.innerHTML = "О сервисе";
          about.setAttribute("key", "about");
          about.addEventListener("click", selectSection);
          ul.appendChild(about);
          nav.appendChild(ul);
          section.appendChild(nav);
          let openNav = document.createElement("div");
          openNav.className = "openNav";
          openNav.addEventListener("click", function(){
            let body = document.querySelector("body");
            let nav = document.querySelector("nav");
            let container = document.querySelector(".container");
            body.classList.toggle("navOpen");
            nav.classList.toggle("open");
            container.classList.toggle("open");
            openNav.classList.toggle("open");
          });
          let icon = document.createElement("div");
          icon.className = "icon";
          openNav.appendChild(icon);
          section.appendChild(openNav);
          document.body.appendChild(section);
        }
        function showComment(event) {
          let target = event.target;
          while (target.className !== "note") {
            target = target.parentNode;
          }
          target.children[0].hidden = !target.children[0].hidden;
        }
        function createFirstForm() {
          let form = document.createElement("form");
          form.setAttribute("name", "createProduct");
          let legend = document.createElement("legend");
          legend.innerHTML = "Добавить новый продукт в коллекцию";
          form.appendChild(legend);
          let div = document.createElement("div");
          div.className = "mui-textfield mui-textfield--float-label";
          input = document.createElement("input");
          input.setAttribute("name", "name1");
          div.appendChild(input);
          let label = document.createElement("label");
          label.innerHTML = "Название продукта";
          div.appendChild(label);
          form.appendChild(div);
          let button = document.createElement("span");
          button.className = "note";
          button.innerHTML = "Примечание";
          let comment = document.createElement("div");
          comment.innerHTML = "<p>Лучше указать запись вида: род + вид. Желательно использовать множественное число.</p>";
          comment.hidden = true;
          button.appendChild(comment);
          button.addEventListener("click", showComment);
          form.appendChild(button);
          let submit = document.createElement("button");
          submit.setAttribute("type", "submit");
          submit.setAttribute("name", "submit1");
          submit.className = "mui-btn";
          submit.innerHTML = "Отправить";
          form.appendChild(submit);
          form.appendChild(document.createElement("br"));
          form.addEventListener("submit", createProduct);
          return form;
        }
        function createSecondForm() {
          let form = document.createElement("form");
          form.setAttribute("name", "addProduct");
          let legend = document.createElement("legend");
          legend.innerHTML = "Добавить продукт";
          form.appendChild(legend);
          let label = document.createElement("label");
          label.innerHTML = "Название продукта";
          form.appendChild(label);
          form.appendChild(document.createElement("br"));
          let select = document.createElement("select");
          select.setAttribute("name", "nameProduct");
          select.className = "mui-select";
          for (let i = 0; i < arrProductsCollection.length; i++) {
            let option = new Option(arrProductsCollection[i], arrProductsCollection[i]);
            select.appendChild(option);
          }
          form.appendChild(select);
          form.appendChild(document.createElement("br"));
          label = document.createElement("label");
          label.innerHTML = "Текущий срок годности";
          form.appendChild(label);
          let shelflife = document.createElement("input");
          shelflife.setAttribute("name", "shelflife");
          form.appendChild(shelflife);
          label = document.createElement("label");
          label.innerHTML = "Количество";
          form.appendChild(label);
          let count = document.createElement("input");
          count.setAttribute("name", "count");
          form.appendChild(count);
          let submit = document.createElement("input");
          submit.setAttribute("type", "submit");
          submit.setAttribute("name", "submit1");
          submit.className = "mui-btn";
          submit.innerHTML = "Отправить";
          form.appendChild(submit);
          form.addEventListener("submit", addProduct);
          return form;
        }
        function createSectionFormProduct() {
          let section = document.createElement("section");
          section.setAttribute("id", "form");
          let form1 = createFirstForm();
          section.appendChild(form1);
          let form2 = createSecondForm();
          section.appendChild(form2);
          section.className = "invisible";
          document.body.querySelector(".container").appendChild(section);
        }
        function createProduct(event) {
          event.preventDefault();
          let value = document.forms[0].elements.name1.value;
          if (!value) {
            alert("Не указано название продукта");
            return;
          }
          value = value.toUpperCase();
          let a = true;
          for (let i = 0; i < arrProductsCollection.length; i++) {
            if (arrProductsCollection[i].toUpperCase() == value) {
              a = false;
            }
          }
          if (a) {
            arrProductsCollection.push(value);
            arrProductsCollection.sort();
            console.log(arrProductsCollection);
            let select = document.querySelector(" #form select");
            select.innerHTML = "";
            for (let i = 0; i < arrProductsCollection.length; i++) {
              let option = new Option(arrProductsCollection[i], arrProductsCollection[i]);
              select.appendChild(option);
            }
          }
        }
        function addProduct(event) {
          event.preventDefault();
          console.log(document.forms[1]);
          let name = document.forms[1].elements.nameProduct.value;
          let shelflife = parseInt(document.forms[1].elements.shelflife.value);
          let count = parseInt(document.forms[1].elements.count.value);
          if (count < 1) {
            alert("Количество не может быть меньше 1шт.");
            return;
          }
          let object = new Object();
          object.name = name;
          object.shelflife = shelflife;
          if (count) {
            object.count = count;
          } else {
            object.count = 1;
          }
          object.datePurchase = new Date();
          object.index = arrProducts.length;
          arrProducts.push(object);
          console.log(arrProducts);
          let tr = document.createElement("tr");
          tr.setAttribute("index", arrProducts.length - 1);
          let td1 = document.createElement("td");
          td1.innerHTML = "<p>" + name + "</p>";
          tr.appendChild(td1);
          let td2 = document.createElement("td");
          td2.innerHTML = "<p>" + shelflife + " дн.</p>";
          tr.appendChild(td2);
          let td3 = document.createElement("td");
          td3.innerHTML = "<p>" + count + " шт.</p>";
          tr.appendChild(td3);
          let td4 = document.createElement("td");
          td4.innerHTML = "<div class='switch' select='off' index='" + (arrProducts.length - 1) + "' count='0'></div>";
          td4.style.padding = "0.5em";
          tr.appendChild(td4);
          document.querySelector(".arr-products tbody").appendChild(tr);
        }
        function updateshelflifes() {
          nowDay = new Date();
          for(let i = 0; i < arrProducts.length; i++) {
            let difference = nowDay - arrProducts[i].datePurchase;
            difference = new Date(difference);
            difference = difference.getDate();
            arrProducts[i].shelflife = arrProducts[i].shelflife - difference;
          }
        }
        function createTableProducts(arr) {
          let table = document.createElement("table");
          table.setAttribute("cellspacing", "0");
          let thead = document.createElement("thead");
          let th1 = document.createElement("th");
          th1.innerHTML = "<p>Род и вид</p>";
          thead.appendChild(th1);
          let th2 = document.createElement("th");
          th2.innerHTML = "<p>Срок годности</p>"
          thead.appendChild(th2)
          let th3 = document.createElement("th");
          th3.innerHTML = "<p>Количество</p>";
          thead.appendChild(th3);
          let th4 = document.createElement("th");
          thead.appendChild(th4);
          table.appendChild(thead);
          let tbody = document.createElement("tbody");
          for (let i = 0; i < arr.length; i++) {
            let tr = document.createElement("tr");
            tr.setAttribute("index", arr[i].index);
            let td1 = document.createElement("td");
            td1.innerHTML = "<p>" + arr[i].name + "</p>";
            let td2 = document.createElement("td");
            td2.innerHTML = "<p>" + arr[i].shelflife + " дн.</p>";
            let td3 = document.createElement("td");
            td3.innerHTML = "<p>" + arr[i].count + "шт. </p>";
            let td4 = document.createElement("td");
            td4.innerHTML = "<div class='switch' select='off' index='" + arr[i].index + "' count='0'></div>";
            td4.style.padding = "0.5em";
            tr.appendChild(td1);
            tr.appendChild(td2);
            tr.appendChild(td3);
            tr.appendChild(td4);
            tbody.appendChild(tr);
          }
          table.appendChild(tbody);
          table.className = "arr-products";
          table.addEventListener("click", toggleChoiceButton);
          return table;
        }
        function rationalChoice() {
          let arrMinshelflife = [];
          let minshelflife = arrProducts[0].shelflife;
          let alertString = "";
          for(let i = 0; i < arrProducts.length; i++) {
              if (arrProducts[i].shelflife < minshelflife) {
                  minshelflife = arrProducts[i].shelflife;
              }
          }
          for(let i = 0; i < arrProducts.length; i++) {
              if(minshelflife == arrProducts[i].shelflife) {
                  arrMinshelflife.push(arrProducts[i]);
              }
          }
          let rows = document.querySelectorAll('.arr-products tr');
          for (let i = 0; i < arrMinshelflife.length; i++) {
            for (let j = 0; j < rows.length; j++) {
              if (rows[j].getAttribute('index') == arrMinshelflife[i].index) {
                rows[j].className = 'lighted';
              }
            }
          }
          let button = document.getElementById("random-choice");
          button.hidden = false;
        }
        function createButtonRationalChoice() {
          let button = document.createElement("div");
          button.className = "button";
          button.innerHTML = "<p>Рациональный выбор</p>";
          button.addEventListener("click", rationalChoice);
          return button;
        }
        function randomChoiceOfRationals() {
          let arrMinshelflife = [];
          let minshelflife = arrProducts[0].shelflife;
          let alertString = "";
          for(let i = 0; i < arrProducts.length; i++) {
              if (arrProducts[i].shelflife < minshelflife) {
                  minshelflife = arrProducts[i].shelflife;
              }
          }
          for(let i = 0; i < arrProducts.length; i++) {
              if(minshelflife == arrProducts[i].shelflife) {
                  arrMinshelflife.push(arrProducts[i]);
              }
          }
           i = getRandomInt(0, (arrMinshelflife.length - 1));
            alert(arrMinshelflife[i].name + " - " + arrMinshelflife[i].shelflife + " дн. " + " - " + arrMinshelflife[i].count + "шт.");
        }
        function createButtonRandomChoiceOfRationals() {
          let button = document.createElement('div');
          button.className = "button";
          button.innerHTML = "<p>Случайная подсказка</p>";
          button.setAttribute("id", "random-choice");
          button.addEventListener("click", randomChoiceOfRationals);
          button.hidden = true;
          return button;
        }
        function toggleChoiceButton(event) {
          let target = event.target;
          if (target.className == "switch" || target.parentNode.className == "switch") {
            if (target.getAttribute("select") == "off") {
              target.style.backgroundColor = "#f40";
              target.setAttribute("select", "on");
              let num = document.createElement('p');
              num.innerHTML = '1';
              target.appendChild(num);
              target.setAttribute("count", "1");
            } else {
              if (target.className !== "switch") {
                target = target.parentNode;
              }
              let i = target.parentNode.parentNode.getAttribute("index");
              let maxCount = arrProducts[i].count;
              let absoluteCount = parseInt(prompt("Сколько всего вы хотите выделить?"));
              if (absoluteCount == 0 || false) {
                target.removeChild(target.firstChild);
                target.style.backgroundColor = "#0f9";
                target.setAttribute("select", "off");
                target.setAttribute("count", "0");
              } else if (absoluteCount > 0) {
                if (absoluteCount > maxCount) {
                  absoluteCount = maxCount;
                }
                target.setAttribute("count", absoluteCount);
                target.innerHTML = "<p>" + absoluteCount + "</p>";
              }
            }
          }
        }
        function saveChanges() {
          let confidence = confirm("Вы уверены, что хотите сохранить результат?");
          if (confidence) {
            let switches = document.body.querySelectorAll(".switch");
            let toTrash = [];
            for (let i = 0; i < switches.length; i++) {
              let j = switches[i].getAttribute("index");
              let maxCount = arrProducts[j].count;
              let count = switches[i].getAttribute("count");
              //console.log(count, maxCount , arrProducts[j],j,i)
              if (count == maxCount) {
                toTrash.push(i)
              } else if (count !== 0) {
                let newCount = maxCount - count;
                arrProducts[j].count = newCount;
                switches[i].setAttribute("count", newCount);
                switches[i].parentNode.parentNode.children[2].innerHTML = newCount + " шт.";
                switches[i].innerHTML = "";
                switches[i].style.backgroundColor = "#0f9";
                switches[i].setAttribute("select", "off");
                switches[i].setAttribute("count", "0");
              }
            }
            if(toTrash.length){
              toTrash.reverse().forEach(i=>{
                deleteProduct(i);
                switches[i].closest('tr').fadeOut(500); 
                setTimeout(function() {
                  switches[i].closest('tr').remove(); 
                }, 600);
              })
              setTimeout(function(){
                let trs = document.querySelectorAll('tbody tr');
                Array.prototype.forEach.call(trs,(e,ind)=>{
                    e.setAttribute('index',ind);
                    e.querySelector('.switch').setAttribute('index',ind);
                })
              },1100)
            }
          }
        }
        function createButtonSaveChanges() {
          let button = document.createElement("div");
          button.className = "button";
          button.innerHTML = "<p>Сохранить изменения</p>";
          button.addEventListener("click", saveChanges);
          return button;
        }
        function createAbout() {
          let section = document.createElement("section");
          section.setAttribute("id", "about");
          section.innerHTML = "<h1>О сервисе</h1><p>Задача программы – автоматическая сортировка продуктов по сроку годности. В будущем будет реализованы рекомендации и список попупок</p><p>Автор – Nick Elixir</p>";
          section.className = "invisible";
          document.body.querySelector(".container").appendChild(section);
        }
        function writeProducts() {
          let div = document.querySelector('.container'); 
          let section = document.createElement("section");
          section.setAttribute("id", "main");
          section.className = "visible";
          section.appendChild(createTableProducts(arrProducts));
          section.appendChild(createButtonRationalChoice());
          section.appendChild(createButtonRandomChoiceOfRationals());
          section.appendChild(createButtonSaveChanges());
          div.appendChild(section);
        }
        createMenu();
        createDivContainer();
        setProduct("Яблоко", 2, 4);
        setProduct("Куриные котлеты", 4, 6);
        setProduct("Сыр", 6);
        setProduct("Колбаса", 2);
        setProduct("Бананы", 2, 6);
        writeProducts();
        createSectionFormProduct();
        createAbout();
    </script>
  </body>
</html>
