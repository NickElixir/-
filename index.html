<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" name=viewport content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="style.css">
    <link href="fonts/Roboto_Condensed/font.css" rel="stylesheet">
  </head>
  <body>
    <script>
        var arrProducts = localStorage.arrProducts ? JSON.parse(localStorage.arrProducts) : [];
        var arrProductsCollection = localStorage.arrProductsCollection ? JSON.parse(localStorage.arrProductsCollection) : [];
        function Product(name, shelfLife, count) {
          this.name = name;
          this.shelfLife = shelfLife;
          this.count = count;
          this.datePurchase = new Date();
          this.datePurchase = this.datePurchase.getTime();
          this.datePurchase = this.datePurchase - (this.datePurchase % 86400000);
          this.countType = document.forms[1].elements.countType.value;
          this.frozen = document.forms[1].elements.checkFrozen.checked;
          this.index = arrProducts.length;
        }
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }
        function fadeOut(time){ 
        let EndTime = Date.now() + time;
        let _this = this;
        handler();
        function handler(){
            let now = Date.now();
            let step = EndTime - now;
            if(step/time < 0 ){
                _this.style.opacity = 0;
                return;            
            }
              else
          _this.style.opacity = (step/time);
            setTimeout(handler,0);
          }
        }
        Element.prototype.fadeOut = fadeOut;
        function isNumeric(n) {
          return !isNaN(parseFloat(n)) && isFinite(n);
        }    
        function setProduct (name, shelfLife, count) {
            let object = new Object();
            object.name = name;
            object.shelfLife = shelfLife;
            if (count) {
              object.count = count;
            } else {
              object.count = 1;
            }
            object.datePurchase = new Date();
            object.index = arrProducts.length;
            arrProducts.push(object);
        }
        function deleteProduct(index){
          arrProducts.splice(index, 1);
        }
        function sortProducts(arr, method) {
          if (method == "name") {
            arr.sort(function (a, b) {
              if (a.name.toUpperCase() < b.name.toUpperCase()) {
                return -1;
              }
              if (a.name.toUpperCase() > b.name.toUpperCase()) {
                return 1;
              }
              // names must be equal
              return 0;
            });
          } else if (method == "shelfLife") {
            arr.sort(function(a, b) {
              if (a.shelfLife < b.shelfLife) {
                return -1;
              }
              if (a.shelfLife > b.shelfLife) {
                return 1;
              }
              return 0;
            });
          } else if (method == "count") {
            arr.sort(function(a, b) {
              if (a.count < b.count) {
                return -1;
              }
              if (a.count > b.count) {
                return 1;
              }
              return 0;
            });
          }
          return arr;
        }
        function createDivContainer() {
          let div = document.createElement("div");
          div.className = "container";
          document.body.appendChild(div);
        }
        function selectSection(event) {
          if (document.body.querySelector(".visible")) {
            document.body.querySelector(".visible").className = "invisible";
            document.body.querySelector("#" + event.target.getAttribute("key")).className = "visible";
            if (document.body.clientWidth < 768) {
              document.querySelector("body").classList.toggle("navOpen");
              document.querySelector("nav").classList.toggle("open");
              document.querySelector(".container").classList.toggle("open");
              document.querySelector(".openNav").classList.toggle("open");
            }
          }
        }
        function createMenu() {
          let section = document.createElement("section");
          section.className = "menu";
          let nav = document.createElement("nav");
          let ul = document.createElement("ul");
          let main = document.createElement("li");
          main.innerHTML = "Главная";
          main.setAttribute("key", "main");
          main.addEventListener("click", selectSection);
          ul.appendChild(main);
          let form = document.createElement("li");
          form.innerHTML = "Добавить продукт";
          form.setAttribute("key", "form");
          form.addEventListener("click", selectSection);
          ul.appendChild(form);
          let about = document.createElement("li");
          about.innerHTML = "О сервисе";
          about.setAttribute("key", "about");
          about.addEventListener("click", selectSection);
          ul.appendChild(about);
          nav.appendChild(ul);
          section.appendChild(nav);
          let openNav = document.createElement("div");
          openNav.className = "openNav";
          openNav.addEventListener("click", function(){
            document.querySelector("body").classList.toggle("navOpen");
            document.querySelector("nav").classList.toggle("open");
            document.querySelector(".container").classList.toggle("open");
            openNav.classList.toggle("open");
          });
          let icon = document.createElement("div");
          icon.className = "icon";
          openNav.appendChild(icon);
          section.appendChild(openNav);
          document.body.appendChild(section);
        }
        function showComment(event) {
          let target = event.target;
          while (target.className !== "note") {
            target = target.parentNode;
          }
          target.children[0].hidden = !target.children[0].hidden;
        }
        function focusRadioParagraph(event) {
          if (event.target.tagName == "P") {
            event.target.children[0].checked = true;
          }
        }
        function createFirstForm() {
          let form = document.createElement("form");
          form.setAttribute("name", "createProduct");
          let legend = document.createElement("legend");
          legend.innerHTML = "Добавить новый продукт в коллекцию";
          form.appendChild(legend);
          let div = document.createElement("div");
          div.className = "mui-textfield";
          let label = document.createElement("label");
          label.innerHTML = "Название продукта";
          div.appendChild(label);
          let input = document.createElement("input");
          input.setAttribute("name", "name1");
          input.type = "text";
          div.appendChild(input);
          form.appendChild(div);
          let button = document.createElement("span");
          button.className = "note";
          button.innerHTML = "Примечание";
          let comment = document.createElement("div");
          comment.innerHTML = "<p>Лучше указать запись вида: род + вид. Желательно использовать множественное число.</p>";
          comment.hidden = true;
          button.appendChild(comment);
          button.addEventListener("click", showComment);
          form.appendChild(button);
          div = document.createElement("div");
          div.className = "mui-textfield";
          label = document.createElement("label");
          label.innerHTML = "Срок годности по умолчанию в холодильнике";
          div.appendChild(label);
          input = document.createElement("input");
          input.setAttribute("name", "defaultShelfLifeFrozen");
          input.type = "text";
          div.appendChild(input);
          form.appendChild(div);
          div = document.createElement("div");
          div.className = "mui-textfield";
          label = document.createElement("label");
          label.innerHTML = "Срок годности по умолчанию при комнатной температуре";
          div.appendChild(label);
          input = document.createElement("input");
          input.setAttribute("name", "defaultShelfLifeNotFrozen");
          input.type = "text";
          div.appendChild(input);
          form.appendChild(div);
          let submit = document.createElement("button");
          submit.type = "submit";
          submit.setAttribute("name", "submit1");
          submit.className = "mui-btn";
          submit.innerHTML = "Отправить";
          form.appendChild(submit);
          form.appendChild(document.createElement("br"));
          form.addEventListener("submit", createProduct);
          return form;
        }
        function createSecondForm() {
          let form = document.createElement("form");
          form.setAttribute("name", "addProduct");
          let legend = document.createElement("legend");
          legend.innerHTML = "Добавить продукт";
          form.appendChild(legend);
          let label = document.createElement("label");
          label.innerHTML = "Название продукта";
          form.appendChild(label);
          form.appendChild(document.createElement("br"));
          let select = document.createElement("select");
          select.setAttribute("name", "name2");
          select.className = "mui-select";
          for (let i = 0; i < arrProductsCollection.length; i++) {
            let option = new Option(arrProductsCollection[i].name, arrProductsCollection[i].name);
            select.appendChild(option);
          }
          select.addEventListener("blur", function(event) {
            let i = 0;
            let selected = event.target.value;
            let product = arrProductsCollection[i];
            while (selected !== product.name) {
              i++;
              product = arrProductsCollection[i];
            }
            if (document.forms[1].elements.checkFrozen.checked) {
              document.forms[1].elements.shelfLife.value = product.shelfLifeFrozen;
            } else {
              document.forms[1].elements.shelfLife.value = product.shelfLifeNotFrozen;
            }
          });
          form.appendChild(select);
          form.appendChild(document.createElement("br"));
          label = document.createElement("label");
          label.innerHTML  ="Продукт в холодильнике или нет?";
          form.appendChild(label);
          form.appendChild(document.createElement("br"));
          let checkbox = document.createElement("input");
          checkbox.name = "checkFrozen";
          checkbox.type = "checkbox";
          checkbox.checked = true;
          checkbox.addEventListener("click", function(event) {
            let i = 0;
            let selected = document.forms[1].elements.name2.value;
            let product = arrProductsCollection[i];
            while (selected !== product.name) {
              i++;
              product = arrProductsCollection[i];
            }
            if (document.forms[1].elements.checkFrozen.checked) {
              document.forms[1].elements.shelfLife.value = product.shelfLifeFrozen;
            } else {
              document.forms[1].elements.shelfLife.value = product.shelfLifeNotFrozen;
            }
          });
          form.appendChild(checkbox);
          let div = document.createElement("div");
          div.className = "mui-textfield";
          label = document.createElement("label");
          label.innerHTML = "Текущий срок годности";
          div.appendChild(label);
          let shelfLife = document.createElement("input");
          shelfLife.setAttribute("name", "shelfLife");
          shelfLife.type = "text";
          if (arrProductsCollection[0]) {
            let i = 0;
            let selected = select.value;
            let product = arrProductsCollection[i];
            while (selected !== product.name) {
              i++;
              product = arrProductsCollection[i];
            }
            shelfLife.value = product.shelfLifeFrozen;
          }
          div.appendChild(shelfLife);
          form.appendChild(div);
          div = document.createElement("div");
          div.className = "mui-textfield";
          label = document.createElement("label");
          label.innerHTML = "Количество";
          div.appendChild(label);
          let count = document.createElement("input");
          count.setAttribute("name", "count");
          count.type = "text";
          count.value = 1;
          div.appendChild(count);
          form.appendChild(div);
          label = document.createElement("label");
          label.innerHTML = "Единица измерения";
          form.appendChild(label);
          let p = document.createElement("p");
          p.className = "radio";
          let radio = document.createElement("input");
          radio.type = "radio";
          radio.setAttribute("name", "countType");
          radio.checked = true;
          radio.value = "ШТ";
          p.appendChild(radio);
          p.appendChild(document.createTextNode("ШТ"));
          p.addEventListener("click", focusRadioParagraph);
          form.appendChild(p);
          p = document.createElement("p");
          p.className = "radio";
          radio = document.createElement("input");
          radio.type = "radio";
          radio.setAttribute("name", "countType");
          radio.value = "КГ";
          p.appendChild(radio);
          p.appendChild(document.createTextNode("КГ"));
          p.addEventListener("click", focusRadioParagraph);
          form.appendChild(p);
          p = document.createElement("p");
          p.className = "radio";
          radio = document.createElement("input");
          radio.type = "radio";
          radio.setAttribute("name", "countType");
          radio.value = "Г";
          p.appendChild(radio);
          p.appendChild(document.createTextNode("Г"));
          p.addEventListener("click", focusRadioParagraph);
          form.appendChild(p);
          let submit = document.createElement("input");
          submit.type = "submit";
          submit.setAttribute("name", "submit1");
          submit.className = "mui-btn";
          submit.innerHTML = "Отправить";
          form.appendChild(submit);
          form.addEventListener("submit", addProduct);
          return form;
        }
        function createSectionFormProduct() {
          let section = document.createElement("section");
          section.setAttribute("id", "form");
          let form1 = createFirstForm();
          section.appendChild(form1);
          let form2 = createSecondForm();
          section.appendChild(form2);
          section.className = "invisible";
          document.body.querySelector(".container").appendChild(section);
        }
        function createProduct(event) {
          event.preventDefault();
          let name = document.forms[0].elements.name1.value;
          let shelfLifeFrozen = parseInt(document.forms[0].elements.defaultShelfLifeFrozen.value);
          let shelfLifeNotFrozen = parseInt(document.forms[0].elements.defaultShelfLifeNotFrozen.value);
          if (!name || !isNumeric(shelfLifeFrozen) || !isNumeric(shelfLifeNotFrozen)) {
            alert("Форма заполнена неправильно");
            return;
          }
          name = name.toUpperCase();
          let a = true;
          for (let i = 0; i < arrProductsCollection.length; i++) {
            if (arrProductsCollection[i].name.toUpperCase() == name) {
              a = false;
            }
          }
          if (a) {
            let object = {};
            object.name = name;
            object.shelfLifeFrozen = shelfLifeFrozen;
            object.shelfLifeNotFrozen = shelfLifeNotFrozen;
            arrProductsCollection.push(object);
            localStorage.arrProductsCollection = JSON.stringify(arrProductsCollection);
            let arr = sortProducts(arrProductsCollection, "name");
            let select = document.querySelector("#form select");
            select.innerHTML = "";
            for (let i = 0; i < arr.length; i++) {
              let option = new Option(arr[i].name, arr[i].name);
              select.appendChild(option);
            }
            alert("Продукт успешно добавлен в коллекцию");
          } else {
          alert("В коллекции уже есть продукт с таким именем");
          }
        }
        function addProduct(event) {
          event.preventDefault();
          let name = document.forms[1].elements.name2.value;
          let count = parseInt(document.forms[1].elements.count.value);
          if (count < 1) {
            alert("Количество не может быть меньше 1шт.");
            return;
          }
          let shelfLife = parseInt(document.forms[1].elements.shelfLife.value);
          let i = 0;
          let product = arrProducts[i];
          while (i < arrProducts.length) {
            if (product.name !== name) {
              i++;
              product = arrProducts[i];
            } else {
              if (product.shelfLife == shelfLife) {
                product.count += count;
                localStorage.arrProducts = JSON.stringify(arrProducts);
                let tr = document.querySelectorAll(".arr-products tr");
                tr[i].children[2].innerHTML = product.count + " " + product.countType;
                alert("Продукт успешкно добавлен");
                return;
              }
              i++;
            }
          }
          let object = new Product(name, shelfLife, count);
          arrProducts.push(object);
          localStorage.arrProducts = JSON.stringify(arrProducts);
          let tr = createTrProduct(arrProducts, object.index);
          document.querySelector(".arr-products tbody").appendChild(tr);
          alert("Продукт успешно добавлен");
        }
        function updateShelfLifes() {
          if (!localStorage._checker) {
            return;
          }
          let nowDay = new Date();
          nowDay = nowDay.getTime();
          nowDay = nowDay - (nowDay % 86400000);
          console.log(localStorage._checker + " " + nowDay);
          if (parseInt(localStorage._checker) !== nowDay) {
            for(let i = 0; i < arrProducts.length; i++) {
              let difference = nowDay - arrProducts[i].datePurchase;
              difference = difference/86400000;
              arrProducts[i].shelfLife = arrProducts[i].shelfLife - difference;
            }
            localStorage.arrProducts = JSON.stringify(arrProducts);
            localStorage._checker = nowDay;
          }
        }
        function createTbodyProducts(arr) {
          let tbody = document.createElement("tbody");
          for (let i = 0; i < arr.length; i++) {
            tbody.appendChild(createTrProduct(arr, i));
          }
          return tbody;
        }
        function createTrProduct(arr, i) {
          let tr = document.createElement("tr");
          tr.setAttribute("index", arr[i].index);
          let td = document.createElement("td");
          td.innerHTML = "<p>" + arr[i].name + "</p>";
          tr.appendChild(td);
          td = document.createElement("td");
          td.innerHTML = "<p>" + arr[i].shelfLife + " дн.</p>";
          tr.appendChild(td);
          td = document.createElement("td");
          td.innerHTML = "<p>" + arr[i].count + " " + arr[i].countType + "</p>";
          tr.appendChild(td);
          td = document.createElement("td");
          td.innerHTML = "<div class='switch' select='off' index='" + arr[i].index + "' count='0'></div>";
          td.style.padding = "0.5em";
          tr.appendChild(td);
          if (arr[i].frozen) {
            tr.className = "frozen";
          }
          return tr;
        }
        function sortTableProducts(event) {
          if (document.querySelector(".arr-products tbody")) {

            switch (event.target.innerHTML[0]) {
              case "Р":
                var arr = sortProducts(arrProducts, "name");
                break;
              case "С":
                var arr = sortProducts(arrProducts, "shelfLife");
                break;   
            }
            let tbody = createTbodyProducts(arr);
            let table = document.querySelector(".arr-products");
            table.removeChild(table.querySelector("tbody"));
            table.appendChild(tbody);
          }
        }
        function createTableProducts(arr) {
          let table = document.createElement("table");
          table.setAttribute("cellspacing", "0");
          let thead = document.createElement("thead");
          let th = document.createElement("th");
          th.innerHTML = "<p>Род и вид</p>";
          th.firstChild.addEventListener("click", sortTableProducts);
          thead.appendChild(th);
          th = document.createElement("th");
          th.innerHTML = "<p>Срок годности</p>"
          th.firstChild.addEventListener("click", sortTableProducts);
          thead.appendChild(th)
          th = document.createElement("th");
          th.innerHTML = "<p>Количество</p>";
          thead.appendChild(th);
          th = document.createElement("th");
          thead.appendChild(th);
          table.appendChild(thead);
          let tbody = createTbodyProducts(arr);
          table.appendChild(tbody);
          table.className = "arr-products";
          table.addEventListener("click", toggleChoiceButton);
          return table;
        }
        function rationalChoice() {
          let arrMinshelfLife = [];
          let minshelfLife = arrProducts[0].shelfLife;
          let alertString = "";
          for(let i = 0; i < arrProducts.length; i++) {
              if (arrProducts[i].shelfLife < minshelfLife) {
                  minshelfLife = arrProducts[i].shelfLife;
              }
          }
          for(let i = 0; i < arrProducts.length; i++) {
              if(minshelfLife == arrProducts[i].shelfLife) {
                  arrMinshelfLife.push(arrProducts[i]);
              }
          }
          let rows = document.querySelectorAll('.arr-products tr');
          for (let i = 0; i < arrMinshelfLife.length; i++) {
            for (let j = 0; j < rows.length; j++) {
              if (rows[j].getAttribute('index') == arrMinshelfLife[i].index) {
                rows[j].className = 'lighted';
              }
            }
          }
          let button = document.getElementById("random-choice");
          button.hidden = false;
        }
        function createButtonRationalChoice() {
          let button = document.createElement("div");
          button.className = "button";
          button.innerHTML = "<p>Рациональный выбор</p>";
          button.addEventListener("click", rationalChoice);
          return button;
        }
        function randomChoiceOfRationals() {
          let arrMinshelfLife = [];
          let minshelfLife = arrProducts[0].shelfLife;
          let alertString = "";
          for(let i = 0; i < arrProducts.length; i++) {
              if (arrProducts[i].shelfLife < minshelfLife) {
                  minshelfLife = arrProducts[i].shelfLife;
              }
          }
          for(let i = 0; i < arrProducts.length; i++) {
              if(minshelfLife == arrProducts[i].shelfLife) {
                  arrMinshelfLife.push(arrProducts[i]);
              }
          }
           i = getRandomInt(0, (arrMinshelfLife.length - 1));
            alert(arrMinshelfLife[i].name + " - " + arrMinshelfLife[i].shelfLife + " дн. " + " - " + arrMinshelfLife[i].count + "шт.");
        }
        function createButtonRandomChoiceOfRationals() {
          let button = document.createElement('div');
          button.className = "button";
          button.innerHTML = "<p>Случайная подсказка</p>";
          button.setAttribute("id", "random-choice");
          button.addEventListener("click", randomChoiceOfRationals);
          button.hidden = true;
          return button;
        }
        function toggleChoiceButton(event) {
          let target = event.target;
          if (target.className == "switch" || target.parentNode.className == "switch") {
            if (target.getAttribute("select") == "off") {
              target.style.backgroundColor = "#f40";
              target.setAttribute("select", "on");
              let num = document.createElement('p');
              num.innerHTML = '1';
              target.appendChild(num);
              target.setAttribute("count", "1");
            } else {
              if (target.className !== "switch") {
                target = target.parentNode;
              }
              let i = target.parentNode.parentNode.getAttribute("index");
              let maxCount = arrProducts[i].count;
              let absoluteCount = parseInt(prompt("Сколько всего вы хотите выделить?"));
              if (absoluteCount == 0 || false) {
                target.removeChild(target.firstChild);
                target.style.backgroundColor = "#0f9";
                target.setAttribute("select", "off");
                target.setAttribute("count", "0");
              } else if (absoluteCount > 0) {
                if (absoluteCount > maxCount) {
                  absoluteCount = maxCount;
                }
                target.setAttribute("count", absoluteCount);
                target.innerHTML = "<p>" + absoluteCount + "</p>";
              }
            }
          }
        }
        function saveChanges() {
          let confidence = confirm("Вы уверены, что хотите сохранить результат?");
          if (confidence) {
            if (!localStorage._checker) {
            let time = new Date();
            time = time.getTime();
            time = time - (time % 86400000);
            localStorage._checker = time;
            }
            let switches = document.body.querySelectorAll(".switch");
            let toTrash = [];
            for (let i = 0; i < switches.length; i++) {
              let j = switches[i].getAttribute("index");
              let maxCount = arrProducts[j].count;
              let count = switches[i].getAttribute("count");
              if (count == maxCount) {
                toTrash.push(i)
              } else if (count !== 0) {
                let newCount = maxCount - count;
                arrProducts[j].count = newCount;
                switches[i].setAttribute("count", newCount);
                switches[i].parentNode.parentNode.children[2].innerHTML = newCount + " " + arrProducts[j].countType;
                switches[i].innerHTML = "";
                switches[i].style.backgroundColor = "#0f9";
                switches[i].setAttribute("select", "off");
                switches[i].setAttribute("count", "0");
              }
            }
            if(toTrash.length){
              toTrash.reverse().forEach(i=>{
                deleteProduct(i);
                switches[i].closest('tr').fadeOut(500); 
                setTimeout(function() {
                  switches[i].closest('tr').remove(); 
                }, 600);
              })
              setTimeout(function(){
                let trs = document.querySelectorAll('tbody tr');
                Array.prototype.forEach.call(trs,(e,ind)=>{
                    e.setAttribute('index',ind);
                    e.querySelector('.switch').setAttribute('index',ind);
                })
              },1100)
            }
          localStorage.arrProducts = JSON.stringify(arrProducts);
          localStorage.arrProductsCollection = JSON.stringify(arrProductsCollection);
          }
        }
        function createButtonSaveChanges() {
          let button = document.createElement("div");
          button.className = "button";
          button.innerHTML = "<p>Сохранить изменения</p>";
          button.addEventListener("click", saveChanges);
          return button;
        }
        function createAbout() {
          let section = document.createElement("section");
          section.setAttribute("id", "about");
          section.innerHTML = "<h1>О сервисе</h1><p>Задача программы – автоматическая сортировка продуктов по сроку годности. В будущем будет реализованы рекомендации и список попупок</p><p>Автор – Nick Elixir</p>";
          section.className = "invisible";
          document.body.querySelector(".container").appendChild(section);
        }
        function writeProducts() {
          let div = document.querySelector('.container'); 
          let section = document.createElement("section");
          section.setAttribute("id", "main");
          section.className = "visible";
          section.appendChild(createTableProducts(arrProducts));
          section.appendChild(createButtonRationalChoice());
          section.appendChild(createButtonRandomChoiceOfRationals());
          section.appendChild(createButtonSaveChanges());
          let p = document.createElement("p");
          p.innerHTML = "При нажатии на заголовок колонки можно отсортировать таблицу по соответстующей характеристике.";
          section.appendChild(p);
          div.appendChild(section);
        }
        updateShelfLifes();
        createMenu();
        createDivContainer();
        writeProducts();
        createSectionFormProduct();
        createAbout();
        console.log(performance.now());
    </script>
  </body>
</html>