<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" name=viewport content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="style.css">
    <link href="fonts/Roboto_Condensed/font.css" rel="stylesheet">
    <script src="element.js"></script>
    <script src="form.js"></script>
    <!--<script src="C:\Users\Николай Луценко\Documents\GitHub\form.js"></script>-->
    <script src="note.js"></script>
    <script src="switch.js"></script>
    <script src="table.js"></script>
	<script src="list.js"></script>
	<script src="menu.js"></script>
    <script src="product.js"></script>
  </head>
  <body>
    <script>
        var arrProducts = localStorage.arrProducts ? JSON.parse(localStorage.arrProducts) : [];
        var productsCollection = localStorage.productsCollection ? JSON.parse(localStorage.productsCollection) : {};
        var shoppingLists = localStorage.shoppingLists ? JSON.parse(localStorage.shoppingLists) : {};
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }
        function fadeOut(time) { 
          let EndTime = Date.now() + time;
          let _this = this;
          handler();
          function handler(){
              let now = Date.now();
              let step = EndTime - now;
              if(step/time < 0 ){
                  _this.style.opacity = 0;
                  return;            
              }
                else
            _this.style.opacity = (step/time);
              setTimeout(handler,0);
            }
        }
        function isNumeric(n) {
        	return !isNaN(parseFloat(n)) && isFinite(n);
        }
        function createDivContainer() {
			document.body.appendChild(new Element("div", {class: "container"}).elem);
        }
        function createMenu() {
		  document.body.appendChild(new Menu([new Li("Главная", {key: "main"}), new Li("Добавить продукт", {key: "form"}), new Li("О сервисе", {key: "about"})]).elem);
        }
        function showComment(event) {
          let target = event.target;
          while (target.className !== "note") {
            target = target.parentNode;
          }
          target.children[0].hidden = !target.children[0].hidden;
        }
        function focusRadioParagraph(event) {
          if (event.target.tagName == "P") {
            event.target.children[0].checked = true;
          }
        }
        function changeShelfLifeValue(event) {
          if (productsCollection) {
            if (event.target.tagName = "select") {
              for (let i in productsCollection) {
                if (i == document.forms.addProduct.elements.name2.value) {
                  if (document.forms.addProduct.elements.checkFrozen.checked) {
                    document.forms.addProduct.elements.shelfLife.value = productsCollection[i].shelfLifeFrozen;
                  } else {
                    document.forms.addProduct.elements.shelfLife.value = productsCollection[i].shelfLifeNotFrozen;
                  }
                  break;
                }
              }
            } else {
              if (document.forms.addProduct.elements.checkFrozen.checked) {
                document.forms.addProduct.elements.shelfLife.value = productsCollection[i].shelfLifeFrozen;
              } else {
                document.forms.addProduct.elements.shelfLife.value = productsCollection[i].shelfLifeNotFrozen;
              }
            }
          }
        }
        function updateShelfLifes() {
          if (!localStorage._checker) return;
          let nowDay = new Date();
          nowDay.setHours(0, 0, 0, 0);
          let checker = new Date(localStorage._checker);
          console.log(checker + " " + nowDay);
          if (parseInt(checker.getTime()) !== nowDay.getTime()) {
            for (let i = 0; i < arrProducts.length; i++) {
              let difference = nowDay.getTime() - checker.getTime();
              difference = difference/86400000;
              console.log("Difference - " + difference); 
              console.log("Current shelf life - " + arrProducts[i].shelfLife);
              arrProducts[i].shelfLife = arrProducts[i].shelfLife - difference;
            }
            localStorage.arrProducts = JSON.stringify(arrProducts);
            localStorage._checker = nowDay;
          }
        }
        function sortTableProducts(event) {
          if (document.querySelector(".arr-products tbody")) {
            switch (event.target.innerHTML[0]) {
              case "Р":
                var arr = sortProducts(arrProducts, "name");
                break;
              case "С":
                var arr = sortProducts(arrProducts, "shelfLife");
                break;
              case "К":
                var arr = sortProducts(arrProducts, "count");
                break;
            }
            let table = document.querySelector(".arr-products");
            table.removeChild(table.querySelector("tbody"));
            table.appendChild(Tbody.products(arr).elem);
          }
        }
        function createTableProducts(arr) {
			let thead = new Tbody("thead", [new Td("th", "Род и вид"), new Td("th", "Срок годности"), new Td("th", "Количество", {colspan: 2})]);
			for (let i in thead.children) thead.children[i].addEventListener("click", sortTableProducts);
      let table = new Table([thead, Tbody.products(arr)], {class: "arr-products", cellspacing: "0"});
			table.elem.addEventListener("click", toggleChoiceButton);
			return table.elem;
        }
        function rationalChoice() {
          let arrMinShelfLife = [];
          let minshelfLife = arrProducts[0].shelfLife;
          let alertString = "";
          for(let i = 0; i < arrProducts.length; i++) {
              if (arrProducts[i].shelfLife < minshelfLife) {
                  minshelfLife = arrProducts[i].shelfLife;
              }
          }
          for(let i = 0; i < arrProducts.length; i++) {
              if(minshelfLife == arrProducts[i].shelfLife) {
                  arrMinShelfLife.push(arrProducts[i]);
              }
          }
          let rows = document.querySelectorAll('.arr-products tr');
          for (let i = 0; i < arrMinShelfLife.length; i++) {
            for (let j = 0; j < rows.length; j++) {
              if (rows[j].getAttribute('index') == arrMinShelfLife[i].index) {
                rows[j].className = 'lighted';
              }
            }
          }
          let button = document.getElementById("random-choice");
          button.hidden = false;
        }
        function createButtonRationalChoice() {
          let button = document.createElement("div");
          button.className = "button";
          button.innerHTML = "<p>Рациональный выбор</p>";
          button.addEventListener("click", rationalChoice);
          return button;
        }
        function randomChoiceOfRationals() {
          let arrMinShelfLife = [];
          let minshelfLife = arrProducts[0].shelfLife;
          let alertString = "";
          for(let i = 0; i < arrProducts.length; i++) {
              if (arrProducts[i].shelfLife < minshelfLife) {
                  minshelfLife = arrProducts[i].shelfLife;
              }
          }
          for(let i = 0; i < arrProducts.length; i++) {
              if(minshelfLife == arrProducts[i].shelfLife) {
                  arrMinShelfLife.push(arrProducts[i]);
              }
          }
           i = getRandomInt(0, (arrMinShelfLife.length - 1));
            alert(arrMinShelfLife[i].name + " - " + arrMinShelfLife[i].shelfLife + " дн " + " - " + arrMinShelfLife[i].count + " " + arrMinShelfLife[i].countType);
        }
        function createButtonRandomChoiceOfRationals() {
          let button = document.createElement('div');
          button.className = "button";
          button.innerHTML = "<p>Случайная подсказка</p>";
          button.setAttribute("id", "random-choice");
          button.addEventListener("click", randomChoiceOfRationals);
          button.hidden = true;
          return button;
        }
        function toggleChoiceButton(event) {
          let target = event.target;
          if (target.className == "switch" || target.parentNode.className == "switch") {
            if (target.getAttribute("select") == "off") {
              target.style.backgroundColor = "#f40";
              target.setAttribute("select", "on");
              let num = document.createElement('p');
              num.innerHTML = '1';
              target.appendChild(num);
              target.setAttribute("count", "1");
            } else {
              if (target.className != "switch") {
                target = target.parentNode;
              }
              let i = target.getAttribute("index");
              let maxCount = arrProducts[i].count;
              let absoluteCount = parseInt(prompt("Сколько всего вы хотите выделить?"));
              if (absoluteCount == 0 || false) {
                target.removeChild(target.firstChild);
                target.style.backgroundColor = "#0f9";
                target.setAttribute("select", "off");
                target.setAttribute("count", "0");
              } else if (absoluteCount > 0) {
                if (absoluteCount > maxCount) {
                  absoluteCount = maxCount;
                }
                target.setAttribute("count", absoluteCount);
                target.innerHTML = "<p>" + absoluteCount + "</p>";
              }
            }
          }
        }
        function saveChanges() {
          let confidence = confirm("Вы уверены, что хотите сохранить результат?");
          if (confidence) {
            if (!localStorage._checker) {
            let time = new Date();
            time.setHours(0, 0, 0, 0);
            localStorage._checker = time;
            }
            let switches = document.body.querySelectorAll(".switch");
            let toTrash = [];
            for (let i = 0; i < switches.length; i++) {
              let j = switches[i].getAttribute("index");
              let maxCount = arrProducts[j].count;
              let count = switches[i].getAttribute("count");
              if (count == maxCount) {
                toTrash.push(i)
              } else if (count !== 0) {
                let newCount = maxCount - count;
                arrProducts[j].count = newCount;
                switches[i].setAttribute("count", newCount);
                switches[i].parentNode.parentNode.children[2].innerHTML = newCount + " " + arrProducts[j].countType;
                switches[i].innerHTML = "";
                switches[i].style.backgroundColor = "#0f9";
                switches[i].setAttribute("select", "off");
                switches[i].setAttribute("count", "0");
              }
            }
            if(toTrash.length){
              toTrash.reverse().forEach(i=>{
                Product.prototype.deleteProduct(i);
                fadeOut.call(switches[i].closest('tr'), 500);
                setTimeout(function() {
                  switches[i].closest('tr').remove(); 
                }, 600);
              })
              setTimeout(function(){
                let trs = document.querySelectorAll('.arr-products tbody tr');
                Array.prototype.forEach.call(trs,(e, ind)=>{
                    e.setAttribute('index', ind);
                    e.querySelector('.switch').setAttribute('index', ind);
                })
              },1100)
            }
          localStorage.arrProducts = JSON.stringify(arrProducts);
          localStorage.productsCollection = JSON.stringify(productsCollection);
          }
        }
        function createButtonSaveChanges() {
          let button = document.createElement("div");
          button.className = "button";
          button.innerHTML = "<p>Сохранить изменения</p>";
          button.addEventListener("click", saveChanges);
          return button;
        }
        function createAbout() {
          let section = document.createElement("section");
          section.setAttribute("id", "about");
          section.innerHTML = "<h1>О сервисе</h1><p>Задача программы – автоматическая сортировка продуктов по сроку годности. В будущем будет реализованы рекомендации и список попупок</p><p>Автор – Nick Elixir</p>";
          section.className = "invisible";
          document.body.querySelector(".container").appendChild(section);
        }
        function writeProducts() {
          let div = document.querySelector('.container'); 
          let section = document.createElement("section");
          section.setAttribute("id", "main");
          section.className = "visible";
          section.appendChild(createTableProducts(arrProducts));
          section.appendChild(createButtonRationalChoice());
          section.appendChild(createButtonRandomChoiceOfRationals());
          section.appendChild(createButtonSaveChanges());
          let p = document.createElement("p");
          p.innerHTML = "При нажатии на заголовок колонки можно отсортировать таблицу по соответстующей характеристике.";
          section.appendChild(p);
          div.appendChild(section);
        }
        function createShoppingListSection() {
          let section = document.createElement("section");
          section.setAttribute("id", "create-shopping-list");
          section.className("invisible");
		      let form = new Form("createShoppingList", [new Input("shoppingListName", "Название")], "Создать список продуктов");
          section.appendChild(form.elem);

        }
        updateShelfLifes();
        createMenu();
        createDivContainer();
        writeProducts();
		//Form for creating and adding products
        document.body.querySelector(".container").appendChild(new Element("section", {id: "form", class: "invisible"}, [Form.createProduct(), Form.addProduct()]).elem);
        createAbout();
        console.log(performance.now());
    </script>
  </body>
</html>